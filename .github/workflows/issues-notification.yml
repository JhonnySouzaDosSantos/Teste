name: Notificar Issues no Discord

on:
  issues:
    types: [opened, closed, reopened]
  issue_comment:
    types: [created]

jobs:
  notificar:
    runs-on: ubuntu-latest
    steps:
      - name: Enviar para Discord
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_ISSUES_WEBHOOK }}
        run: |
          # Determina o tipo de evento
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            # Evento de comentÃ¡rio
            EVENT_TYPE="comment"
            ISSUE_URL=${{ github.event.issue.html_url }}
            ISSUE_TITLE=${{ github.event.issue.title }}
            USER=${{ github.event.comment.user.login }}
            COMMENT=${{ github.event.comment.body }}
            ACTION=${{ github.event.action }}
            STATE=${{ github.event.issue.state }}
            
            # Se a issue foi fechada/reaberta com este comentÃ¡rio
            if [ "$ACTION" = "created" ] && [ "${{ github.event.issue.state }}" != "${{ github.event.issue.state_prev }}" ]; then
              EVENT_TYPE="state_change_with_comment"
              STATE_CHANGE=${{ github.event.issue.state }}
            fi
          else
            # Evento de issue normal
            EVENT_TYPE=${{ github.event.action }}
            ISSUE_URL=${{ github.event.issue.html_url }}
            ISSUE_TITLE=${{ github.event.issue.title }}
            USER=${{ github.event.issue.user.login }}
          fi

          # Construir mensagem base
          MESSAGE+="\nâ€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•"
          MESSAGE="ğŸ“¢ **Atividade em Issues**\n"
          MESSAGE+="ğŸ”¹ **Tipo:** \`$EVENT_TYPE\`\n"
          MESSAGE+="ğŸ”¹ **TÃ­tulo:** [$ISSUE_TITLE]($ISSUE_URL)\n"
          MESSAGE+="ğŸ”¹ **Autor:** $USER\n"

          # Adicionar informaÃ§Ãµes especÃ­ficas
          case $EVENT_TYPE in
            "opened")
              MESSAGE+="ğŸŸ¢ **Issue aberta**\n"
              MESSAGE+="\nâ€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•"
              ;;
            "closed")
              MESSAGE+="ğŸ”´ **Issue fechada**\n"
              MESSAGE+="\nâ€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•"
              ;;
            "reopened")
              MESSAGE+="ğŸŸ  **Issue reaberta**\n"
              MESSAGE+="\nâ€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•"
              ;;
            "state_change_with_comment")
              MESSAGE+="ğŸ”„ **Issue $STATE_CHANGE com comentÃ¡rio**\n"
              MESSAGE+="ğŸ’¬ **ComentÃ¡rio:** ${COMMENT:0:100}...\n"
              MESSAGE+="\nâ€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•"
              ;;
            "comment")
              MESSAGE+="ğŸ’¬ **Novo comentÃ¡rio**\n"
              MESSAGE+="ğŸ“ ${COMMENT:0:100}...\n"
              MESSAGE+="\nâ€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•"
              ;;
          esac

          # Envia para o Discord
          curl -X POST \
               -H "Content-Type: application/json" \
               -d "{\"content\":\"$MESSAGE\"}" \
               "$WEBHOOK_URL"