name: Notificar Issues no Discord

on:
  issues:
    types: [opened, closed, reopened]
  issue_comment:
    types: [created]

jobs:
  notificar:
    runs-on: ubuntu-latest
    steps:
      - name: Enviar para Discord
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_ISSUES_WEBHOOK }}
        run: |
          # Determina o tipo de evento
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            # Evento de coment치rio
            EVENT_TYPE="comment"
            ISSUE_URL=${{ github.event.issue.html_url }}
            ISSUE_TITLE=${{ github.event.issue.title }}
            USER=${{ github.event.comment.user.login }}
            COMMENT=${{ github.event.comment.body }}
            ACTION=${{ github.event.action }}
            STATE=${{ github.event.issue.state }}
            
            # Se a issue foi fechada/reaberta com este coment치rio
            if [ "$ACTION" = "created" ] && [ "${{ github.event.issue.state }}" != "${{ github.event.issue.state_prev }}" ]; then
              EVENT_TYPE="state_change_with_comment"
              STATE_CHANGE=${{ github.event.issue.state }}
            fi
          else
            # Evento de issue normal
            EVENT_TYPE=${{ github.event.action }}
            ISSUE_URL=${{ github.event.issue.html_url }}
            ISSUE_TITLE=${{ github.event.issue.title }}
            USER=${{ github.event.issue.user.login }}
          fi

          # Construir mensagem base
          MESSAGE="游닉 **Atividade em Issues**\n"
          MESSAGE+="游댳 **Tipo:** \`$EVENT_TYPE\`\n"
          MESSAGE+="游댳 **T칤tulo:** [$ISSUE_TITLE]($ISSUE_URL)\n"
          MESSAGE+="游댳 **Autor:** $USER\n"

          # Adicionar informa칞칫es espec칤ficas
          case $EVENT_TYPE in
            "opened")
              MESSAGE+="游릭 **Issue aberta**\n"
              ;;
            "closed")
              MESSAGE+="游댮 **Issue fechada**\n"
              ;;
            "reopened")
              MESSAGE+="游 **Issue reaberta**\n"
              ;;
            "state_change_with_comment")
              MESSAGE+="游댃 **Issue $STATE_CHANGE com coment치rio**\n"
              MESSAGE+="游눫 **Coment치rio:** ${COMMENT:0:100}...\n"
              ;;
            "comment")
              MESSAGE+="游눫 **Novo coment치rio**\n"
              MESSAGE+="游닇 ${COMMENT:0:100}...\n"
              ;;
          esac

          # Envia para o Discord
          curl -X POST \
               -H "Content-Type: application/json" \
               -d "{\"content\":\"$MESSAGE\"}" \
               "$WEBHOOK_URL"