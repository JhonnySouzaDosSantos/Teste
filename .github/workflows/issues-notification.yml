name: Notificar Issues no Discord

on:
  issues:
    types: [opened, closed, reopened]
  issue_comment:
    types: [created]

jobs:
  notificar:
    runs-on: ubuntu-latest
    steps:
      - name: Enviar para Discord
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_ISSUES_WEBHOOK }}
        run: |
          # Dados b치sicos da issue
          ISSUE_URL="${{ github.event.issue.html_url }}"
          ISSUE_TITLE="${{ github.event.issue.title }}"
          USER="${{ github.event.issue.user.login }}"

          # Mensagem base
          MESSAGE="游닉 **Nova Atividade em Issues**\n"
          MESSAGE+="游댳 **T칤tulo:** [$ISSUE_TITLE]($ISSUE_URL)\n"
          MESSAGE+="游댳 **Autor:** $USER\n"

          # Verifica o tipo de evento
          if [ "${{ github.event_name }}" = "issues" ]; then
            MESSAGE+="游댳 **Tipo:** \`${{ github.event.action }}\`\n"
          elif [ "${{ github.event_name }}" = "issue_comment" ]; then
            MESSAGE+="游댳 **Tipo:** \`comment\`\n"
            # Escapa o coment치rio para evitar problemas com espa칞os/caracteres especiais
            COMMENT="${{ github.event.comment.body }}"
            MESSAGE+="游눫 **Coment치rio:** ${COMMENT:0:100}...\n"  # Limita a 100 chars
          fi

          # Envia para o Discord (com escape seguro de JSON)
          ESCAPED_MESSAGE=$(echo "$MESSAGE" | jq -Rs . | sed 's/^"//; s/"$//')
          curl -X POST \
               -H "Content-Type: application/json" \
               -d "{\"content\":$ESCAPED_MESSAGE}" \
               "$WEBHOOK_URL"