name: Notificar no Discord

on:
  push:
    branches:
      - '**'

jobs:
  enviar-mensagem:
    runs-on: ubuntu-latest

    steps:
      - name: Checar o cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Enviar notificaÃ§Ã£o para o Discord
        env:
          DISCORD_WEBHOOK_URL: "https://discord.com/api/webhooks/1394547222389194762/Q7b3I0tLxsbxQNiP9jRZQQx7uGx-9sVMcIrcItoIurbnidX9RlUG3I1a25eOyZZasFAl?thread_id=1394542894626377790"  # Substitua pelo seu URL real
        run: |
          # ObtÃ©m todos os commits do push
          COMMITS=$(git log --pretty=format:"%h|%an|%s" ${{ github.event.before }}..${{ github.sha }} || git log -1 --pretty=format:"%h|%an|%s")

          # Monta a mensagem PRINCIPAL (tÃ­tulo)
          MESSAGE="ðŸ“Œ **Novo Push no RepositÃ³rio!**\nðŸŒ¿ **Branch:** ${{ github.ref_name }}\nðŸ”¢ **Total de Commits:** $(echo "$COMMITS" | wc -l)\n\n"
          
          while IFS='|' read -r HASH USER MSG; do
            MESSAGE+="â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\n"
            MESSAGE+="ðŸ‘¤ **UsuÃ¡rio:** $USER\n"
            MESSAGE+="ðŸ†” **Hash:** \`$HASH\`\n"
            MESSAGE+="ðŸ’¬ **Mensagem:** $MSG\n\n"
          done <<< "$COMMITS"

          # Remove caracteres invÃ¡lidos (seguranÃ§a extra)
          MESSAGE_CLEANED=$(echo "$MESSAGE" | tr -cd '\11\12\15\40-\176')

          # Envia para o Discord (com formataÃ§Ã£o JSON segura)
          JSON_PAYLOAD=$(jq -n --arg content "$MESSAGE_CLEANED" '{content: $content}')
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "$JSON_PAYLOAD" \
               "$DISCORD_WEBHOOK_URL"