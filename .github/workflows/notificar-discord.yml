name: Notificar no Discord

on:
  push:
    branches:
      - '**'

jobs:
  enviar-mensagem:
    runs-on: ubuntu-latest

    steps:
      - name: Checar o cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # NecessÃ¡rio para pegar histÃ³rico completo

      - name: Enviar notificaÃ§Ã£o para o Discord
        env:
          DISCORD_WEBHOOK_URL: "https://discord.com/api/webhooks/1394547222389194762/Q7b3I0tLxsbxQNiP9jRZQQx7uGx-9sVMcIrcItoIurbnidX9RlUG3I1a25eOyZZasFAl?thread_id=1394542894626377790"  # Substitua pelo seu URL real
        run: |
          # ObtÃ©m todos os commits do push atual (usando git log para comparar SHAs)
          COMMITS=$(git log --pretty=format:"%h|%an|%s" ${{ github.event.before }}..${{ github.sha }})

          # Se for um push forÃ§ado ou sem histÃ³rico, pega apenas o Ãºltimo commit
          if [ -z "$COMMITS" ]; then
            COMMITS=$(git log -1 --pretty=format:"%h|%an|%s")
          fi

          # Contador de commits
          TOTAL_COMMITS=$(echo "$COMMITS" | wc -l)

          # Monta a mensagem principal
          MESSAGE="ðŸ“Œ **Novo Push no RepositÃ³rio!**\n"
          MESSAGE+="ðŸ”¢ **Total de Commits:** $TOTAL_COMMITS\n"
          MESSAGE+="ðŸŒ¿ **Branch:** ${{ github.ref_name }}\n\n"

          # Adiciona detalhes de CADA commit
          while IFS='|' read -r HASH USER MSG; do
            MESSAGE+="â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\n"
            MESSAGE+="ðŸ‘¤ **Usuario:** $USER\n"
            MESSAGE+="ðŸ†” **Hash:** \`$HASH\`\n"
            MESSAGE+="ðŸ’¬ **Mensagem:** $MSG\n\n"
          done <<< "$COMMITS"

          # Envia para o Discord (usando jq para evitar problemas de formataÃ§Ã£o)
          JSON_PAYLOAD=$(jq -n --arg content "$MESSAGE" '{content: $content}')
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "$JSON_PAYLOAD" \
               "$DISCORD_WEBHOOK_URL"