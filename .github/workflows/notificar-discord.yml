name: Notificar no Discord

on:
  push:
    branches:
      - '**'

jobs:
  enviar-mensagem:
    runs-on: ubuntu-latest

    steps:
      - name: Checar o cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Enviar notificaÃ§Ã£o formatada
        env:
          DISCORD_WEBHOOK_URL: "https://discord.com/api/webhooks/1394547222389194762/Q7b3I0tLxsbxQNiP9jRZQQx7uGx-9sVMcIrcItoIurbnidX9RlUG3I1a25eOyZZasFAl?thread_id=1394542894626377790"
        run: |
          # ObtÃ©m commits de forma segura
          COMMITS=$(git log --pretty=format:"%h|%an|%s" ${{ github.event.before }}..${{ github.sha }} 2>/dev/null || git log -1 --pretty=format:"%h|%an|%s")

          # CabeÃ§alho fixo
          MESSAGE="ðŸ“Œ **Novo Push no RepositÃ³rio!**"
          MESSAGE+="\nðŸŒ¿ **Branch:** ${{ github.ref_name }}"
          MESSAGE+="\nðŸ”¢ **Total de Commits:** $(echo "$COMMITS" | wc -l)\n"

          # Processa cada commit
          while IFS='|' read -r HASH USER MSG; do
            MESSAGE+="\nâ€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•"
            MESSAGE+="\nðŸ‘¤ **UsuÃ¡rio:** $USER"
            MESSAGE+="\nðŸ†” **Hash:** \`$HASH\`"
            MESSAGE+="\nðŸ’¬ **Mensagem:** $MSG"
          done <<< "$COMMITS"

          # Remove TODOS os caracteres nÃ£o-ASCII
          MESSAGE_CLEAN=$(echo "$MESSAGE" | LC_ALL=C tr -dc '[:print:]\n')

          # Envia usando Python para garantir o JSON perfeito
          python3 -c "
          import json, os
          payload = {'content': os.environ.get('MESSAGE_CLEAN')}
          import urllib.request
          req = urllib.request.Request(
              os.environ.get('DISCORD_WEBHOOK_URL'),
              data=json.dumps(payload).encode('utf-8'),
              headers={'Content-Type': 'application/json'}
          )
          urllib.request.urlopen(req)
          "